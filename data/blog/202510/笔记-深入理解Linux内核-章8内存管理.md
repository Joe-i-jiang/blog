---
title: 笔记-深入理解Linux内核-章8内存管理
date: '2025-10-23'
lastmod: '2025-10-23'
tags: ['深入理解Linux内核', 'Linux内核', '笔记', '内存']
draft: false
summary: '阅读深入理解linux内核，第八章，笔记。'
authors: ['default']
---

## 页框管理

RAM的某些部分永久分配给内核，存放内核代码以及静态内核数据结构。而其余部分就是动态内存。  
下面是用作动态内存的页框，和章2的物理内存布局一致  
**_链接1_**

### 页描述符

内核必须记录每个页框的状态。比如：哪些是进程的，哪些是内核代码，哪些是内核数据等。如果动态内存不包含有用的数据，就是空闲的。  
页框的状态信息保存在一个类型为`page`的页描述符中。所有的页描述符存放在`mem_map`数组中。  
`virt_to_page(addr)`宏产生线性地址对应的页描述符，`pfn_to_page`宏产生页框号对应的页描述符。  
下面是页描述符字段：

1. `unsigned long flags`：一组标志。
2. `atomic_t _count`：页框引用计数。
3. `atomic_t _mapcount`：页框中的页表项数。
4. `unsigned long private`：用于正在使用页的内核成分。空闲时，由伙伴关系使用。
5. `struct address_space * mapping`：当页被插入页高速缓存中时使用。当页属于匿名区时使用。
6. `unsigned long index`：具有不同含义。
7. `struct list_head lru`：包含页的最近最少使用（LRU）双向链表的指针。

#### **flag**字段

包含多达32位的标志。对每个标志`PG_*`，定义了一些宏。`Page*`返回值；`SetPage*`和`ClearPage*`表示设置和清除。  
**_链接2_**

### 非一致内存访问（NUMA）

对于单一cpu，对物理内存的访问时间都相同，但对于多处理器不一定。  
对于支持NUMA的模型的cpu访问不同内存时间可能不一样。系统的物理内存分为了几个节点。而对于每个CPU来说，内核都试图将访问的次数减到最少。

> **空洞**：
> "空洞"指的是物理地址空间中的不连续区域。比如
>
> ```c
> // 典型的物理地址空间布局（有空洞）
> +---------------------+ 0x00000000
> |   节点0内存         |
> |   (连续)           |
> +---------------------+ 0x20000000  ← 空洞开始
> |     空洞区域        |
> |   (无物理内存)      |
> +---------------------+ 0x40000000  ← 空洞结束
> |   节点1内存         |
> |   (连续)           |
> +---------------------+ 0x60000000
> |     空洞区域        |
> |   (无物理内存)      |
> +---------------------+ 0x80000000
> |   节点2内存         |
> |   (连续)           |
> +---------------------+ 0xA0000000
> ```
>
> 而对于某些单一的cpu系统上使用了**NUMA**可能会造成巨大的**空洞**。例如：
>
> ```c
> // 即使只有一个物理CPU，NUMA架构也强制使用多节点内存映射
> +-----------------------------+
> |       单一物理CPU           |
> |   (包含多个核心和内存控制器)  |
> +-----------------------------+
> | 内存控制器0  | 内存控制器1   |
> | 映射到节点0  | 映射到节点1   |
> +-------------+---------------+
> | 本地内存    | 本地内存       |
> | 0-16GB      | 16-32GB       |
> +-------------+---------------+
>
> // 问题：两个内存控制器的地址空间必须隔离
> // 导致：节点0: 0x0 - 0x400000000 (16GB)
> //       节点1: 0x800000000 - 0xC00000000 (16GB)
> //       中间空洞: 0x400000000 - 0x800000000 (16GB空洞!)
> ```
>
> 每个节点的物理内存又可以分为几个管理区。每个节点有一个类型为`pg_data_t`的描述符。所有节点都放在单链表，第一个变量由`pgdat_list`指向。  
> 节点描述符表[略]

即使NUMA的支持没有编译进内核，但linux还是使用节点，一个节点包含了所有物理内存。这样做的原因是为了可移植性，假设物理内存被分为一个或多个节点。

### 内存管理区

linux2.6将每个内存节点的物理内存分为3个管理区。

1. `ZONE_DMA`：包含低于16MB的内存页框。
2. `ZONE_NORMAL`：包含高于16MB并且低于896MB的内存页框。可以和`ZONE_DMA`一样，直接访问线性地址映射到的第四个GB的物理内存。
3. `ZONE_HIGHMEM`：包含高于且等于896MB的内存页框。不能由内核直接访问。在64位体系上，`ZONE_HIGHMEM`区总是空的。
   > ISA总线的直接内存存取(DMA)处理器有一个严格的限制:它们只能对RAM的前16MB寻址。  
   > 在具有大容量RAM的现代32位计算机中，CPU不能直接访问所有的物理内存，因为线性地址空间太小。

> 每个内存管理区都有自己的描述符。这里略。
